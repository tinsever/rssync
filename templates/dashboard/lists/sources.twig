{% extends 'layout/dashboard.twig' %}

{% block title %}Quellen für {{ list.name }} - {{ app_name }}{% endblock %}

{% block dashboard_content %}
<div class="card">
    <div class="card-content">
        <span class="card-title">Quellen für "{{ list.name }}"</span>
        <p class="grey-text" style="margin-bottom: 1.5rem;">
            Wählen Sie die Quellen aus, die in dieser Liste enthalten sein sollen. 
            Sie können aus allen verfügbaren Quellen wählen und Filter setzen.
        </p>
        
        <form id="sources-form" action="/dashboard/lists/{{ list.id }}/sources" method="POST">
            <!-- Hidden fields for filter values (will be populated by JS before submit) -->
            <div id="hidden-filters"></div>
            
            {% if sources is empty %}
                <p class="grey-text">
                    Keine Quellen verfügbar. <a href="{{ url_for('dashboard.sources.create') }}">Erstellen Sie zuerst eine Quelle.</a>
                </p>
            {% else %}
                <table class="striped">
                    <thead>
                        <tr>
                            <th style="width: 30px;"></th>
                            <th>Quelle</th>
                            <th>Kategorie</th>
                            <th>Artikel</th>
                            <th>Filter</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for source in sources %}
                        {% set isSelected = listSources[source.id] is defined %}
                        {% set currentFilter = listSources[source.id] ?? null %}
                        {% set filters = sourceFilters[source.id] ?? {authors: [], categories: []} %}
                        <tr>
                            <td>
                                <label>
                                    <input type="checkbox" name="sources[]" value="{{ source.id }}" class="filled-in" {% if isSelected %}checked{% endif %}>
                                    <span></span>
                                </label>
                            </td>
                            <td>{{ source.name }}</td>
                            <td><span class="chip">{{ source.category.name }}</span></td>
                            <td>{{ source.feed_items_count }}</td>
                            <td>
                                <a class="btn-flat btn-small waves-effect modal-trigger" href="#filter-{{ source.id }}">
                                    <i class="material-icons">filter_list</i>
                                    {% if currentFilter and (currentFilter.author_whitelist or currentFilter.author_blacklist or currentFilter.category_whitelist or currentFilter.category_blacklist) %}
                                        <span class="new badge blue" data-badge-caption="">aktiv</span>
                                    {% endif %}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
            
            <div class="row" style="margin-top: 2rem;">
                <div class="col s12">
                    <button type="submit" class="btn waves-effect waves-light blue">
                        <i class="material-icons left">save</i>Speichern
                    </button>
                    <a href="{{ url_for('dashboard.lists') }}" class="btn waves-effect waves-light grey">
                        Zurück
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Filter Modals (outside form, values copied via JS) -->
{% for source in sources %}
{% set currentFilter = listSources[source.id] ?? null %}
{% set filters = sourceFilters[source.id] ?? {authors: [], categories: []} %}
<div id="filter-{{ source.id }}" class="modal" data-source-id="{{ source.id }}">
    <div class="modal-content">
        <h5>Filter für {{ source.name }}</h5>
        
        {% if filters.authors is empty and filters.categories is empty %}
            <p class="orange-text">
                <i class="material-icons tiny">warning</i>
                Diese Quelle wurde noch nicht gecrawlt. Bitte erst die Quelle aktualisieren um Filter nutzen zu können.
            </p>
        {% else %}
            <div class="row">
                <div class="input-field col s12 m6">
                    <select class="filter-select" data-source="{{ source.id }}" data-filter="author_whitelist" multiple>
                        {% for author in filters.authors %}
                            {% set authorList = currentFilter.author_whitelist ? currentFilter.author_whitelist|split(',') : [] %}
                            <option value="{{ author }}" {% if author in authorList %}selected{% endif %}>{{ author }}</option>
                        {% endfor %}
                    </select>
                    <label>Autoren (nur diese)</label>
                    <span class="helper-text">Nur Artikel dieser Autoren anzeigen</span>
                </div>
                <div class="input-field col s12 m6">
                    <select class="filter-select" data-source="{{ source.id }}" data-filter="author_blacklist" multiple>
                        {% for author in filters.authors %}
                            {% set authorList = currentFilter.author_blacklist ? currentFilter.author_blacklist|split(',') : [] %}
                            <option value="{{ author }}" {% if author in authorList %}selected{% endif %}>{{ author }}</option>
                        {% endfor %}
                    </select>
                    <label>Autoren (ausschließen)</label>
                    <span class="helper-text">Artikel dieser Autoren ausblenden</span>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12 m6">
                    <select class="filter-select" data-source="{{ source.id }}" data-filter="category_whitelist" multiple>
                        {% for cat in filters.categories %}
                            {% set catList = currentFilter.category_whitelist ? currentFilter.category_whitelist|split(',') : [] %}
                            <option value="{{ cat }}" {% if cat in catList %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <label>Kategorien (nur diese)</label>
                    <span class="helper-text">Nur Artikel mit diesen Tags anzeigen</span>
                </div>
                <div class="input-field col s12 m6">
                    <select class="filter-select" data-source="{{ source.id }}" data-filter="category_blacklist" multiple>
                        {% for cat in filters.categories %}
                            {% set catList = currentFilter.category_blacklist ? currentFilter.category_blacklist|split(',') : [] %}
                            <option value="{{ cat }}" {% if cat in catList %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <label>Kategorien (ausschließen)</label>
                    <span class="helper-text">Artikel mit diesen Tags ausblenden</span>
                </div>
            </div>
        {% endif %}
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close btn waves-effect waves-light blue">OK</a>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    var modals = document.querySelectorAll('.modal');
    M.Modal.init(modals);
    
    // Initialize selects in modals
    var selects = document.querySelectorAll('.filter-select');
    M.FormSelect.init(selects);
    
    // Before form submit, copy all filter values to hidden fields
    document.getElementById('sources-form').addEventListener('submit', function(e) {
        var hiddenContainer = document.getElementById('hidden-filters');
        hiddenContainer.innerHTML = '';
        
        document.querySelectorAll('.filter-select').forEach(function(select) {
            var sourceId = select.dataset.source;
            var filterType = select.dataset.filter;
            var selectedValues = M.FormSelect.getInstance(select).getSelectedValues();
            
            selectedValues.forEach(function(value) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'filters[' + sourceId + '][' + filterType + '][]';
                input.value = value;
                hiddenContainer.appendChild(input);
            });
        });
    });
});
</script>
{% endblock %}
